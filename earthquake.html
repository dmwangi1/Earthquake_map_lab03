<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <title>Earthquake Map</title>
    <!-- Mapbox CSS -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        #container { display: flex; height: 100vh; }
        #side-panel { width: 300px; overflow-y: auto; padding: 10px; background-color: #f7f7f7; }
        #map { flex: 1; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 4px; text-align: center; }
        th { background-color: #eee; }
        button { margin-bottom: 10px; padding: 5px 10px; cursor: pointer; }
    </style>
</head>
<body>
    <main id="container">
        <div id="side-panel">
            <h2>Earthquake List</h2>
            <button>Sort by Magnitude</button>
            <table>
                <tr>
                    <th>id</th>
                    <th>magnitude</th>
                    <th>timestamp</th>
                </tr>
            </table>
        </div>
        <div id="map"></div>
    </main>

    <!-- Mapbox JS -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoiZG13YW5naTExIiwiYSI6ImNtaGp5NDcwbTFnY2EyanB1OTY0Y28zYzYifQ.Y0y8yh2dg6NS-434lyO14w';

        const map = new mapboxgl.Map({
            container: 'map', 
            style: 'mapbox://styles/mapbox/light-v11',
            center: [138, 38], 
            zoom: 4
        });

        async function geojsonFetch() {
            let response, earthquakes, japan, table;

            // Fetch earthquake data
            response = await fetch('assets/earthquakes.geojson');
            earthquakes = await response.json();

            // Fetch Japan boundaries
            response = await fetch('assets/japan.json');
            japan = await response.json();

            // Build table
            table = document.getElementsByTagName("table")[0];
            for (let i = 0; i < earthquakes.features.length; i++) {
                const row = table.insertRow(-1);
                row.insertCell(0).innerHTML = earthquakes.features[i].properties.id;
                row.insertCell(1).innerHTML = earthquakes.features[i].properties.mag;
                row.insertCell(2).innerHTML = new Date(
                    earthquakes.features[i].properties.time
                ).toLocaleDateString("en-US");
            }

            // Add map layers after map loads
            map.on('load', function loadingData() {
                map.addSource('earthquakes', { type: 'geojson', data: earthquakes });
                map.addLayer({
                    id: 'earthquakes-layer',
                    type: 'circle',
                    source: 'earthquakes',
                    paint: {
                        'circle-radius': 8,
                        'circle-stroke-width': 2,
                        'circle-color': 'red',
                        'circle-stroke-color': 'white'
                    }
                });

                map.addSource('japan', { type: 'geojson', data: japan });
                map.addLayer({
                    id: 'japan-layer',
                    type: 'fill',
                    source: 'japan',
                    paint: {
                        'fill-color': '#0080ff',
                        'fill-opacity': 0.5
                    }
                });
            });
        }

        // Sort table button
        let btn = document.getElementsByTagName("button")[0];
        btn.addEventListener('click', sortTable);

        function sortTable(e) {
            let table, rows, switching, i, x, y, shouldSwitch;
            table = document.getElementsByTagName("table")[0];
            switching = true;
            while (switching) {
                switching = false;
                rows = table.rows;
                for (i = 1; i < (rows.length - 1); i++) {
                    shouldSwitch = false;
                    x = parseFloat(rows[i].getElementsByTagName("td")[1].innerHTML);
                    y = parseFloat(rows[i + 1].getElementsByTagName("td")[1].innerHTML);
                    if (x < y) {
                        shouldSwitch = true;
                        break;
                    }
                }
                if (shouldSwitch) {
                    rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                    switching = true;
                }
            }
        }

        geojsonFetch();
    </script>
</body>
</html>
